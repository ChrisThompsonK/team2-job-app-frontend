{% extends "templates/layout.njk" %}

{% block title %}Forgot Password - {{ super() }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-base-200 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-md w-full space-y-8">
    <div class="text-center">
      <h2 class="text-3xl font-extrabold text-base-content">
        Forgot your password?
      </h2>
      <p class="mt-2 text-sm text-base-content/70">
        No worries! Enter your email address and we'll send you a link to reset your password.
      </p>
    </div>

    <!-- Error Alert -->
    {% if error %}
    <div class="alert alert-error">
      <div class="flex-1">
        <svg class="w-6 h-6 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <label>{{ error }}</label>
      </div>
    </div>
    {% endif %}

    <!-- Success Alert -->
    <div id="success-alert" class="alert alert-success hidden">
      <div class="flex-1">
        <svg class="w-6 h-6 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <label id="success-message"></label>
      </div>
    </div>

    <form id="forgot-password-form" class="mt-8 space-y-6" method="POST">
      <div class="space-y-4">
        <!-- Email Field -->
        <div class="form-control">
          <label class="label" for="email">
            <span class="label-text">Email address</span>
          </label>
          <div class="relative">
            <input 
              id="email" 
              name="email" 
              type="email" 
              autocomplete="email" 
              required 
              class="input input-bordered w-full pr-10"
              placeholder="Enter your email address"
              value="{{ formData.email if formData else '' }}"
            />
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <svg id="email-loading" class="hidden animate-spin h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <svg id="email-success" class="hidden h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              <svg id="email-error" class="hidden h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
            </div>
          </div>
          <label class="label">
            <span id="email-error-text" class="label-text-alt text-error hidden"></span>
            <span class="label-text-alt text-base-content/70">We'll send you a password reset link</span>
          </label>
        </div>
      </div>

      <!-- Submit Button -->
      <div>
        <button 
          type="submit" 
          id="reset-button"
          class="btn btn-primary w-full"
        >
          <span id="reset-button-text">Send Reset Link</span>
          <span id="reset-loading" class="hidden loading loading-spinner loading-sm"></span>
        </button>
      </div>

      <!-- Back to Sign In -->
      <div class="text-center">
        <p class="text-sm text-base-content/70">
          Remember your password? 
          <a href="/auth/signin" class="font-medium text-primary hover:text-primary-focus">
            Back to sign in
          </a>
        </p>
      </div>
    </form>

    <!-- Help Section -->
    <div class="mt-8 p-4 bg-base-100 rounded-lg border border-base-300">
      <h3 class="text-lg font-semibold text-base-content mb-2">Need help?</h3>
      <ul class="text-sm text-base-content/70 space-y-1">
        <li>• Check your spam/junk folder for the reset email</li>
        <li>• The reset link will expire in 24 hours</li>
        <li>• Contact support if you continue to have issues</li>
      </ul>
    </div>
  </div>
</div>

<script>
  // Enhanced forgot password JavaScript
  const forgotPasswordForm = document.getElementById('forgot-password-form');
  const emailInput = document.getElementById('email');
  const resetButton = document.getElementById('reset-button');
  const resetButtonText = document.getElementById('reset-button-text');
  const resetLoading = document.getElementById('reset-loading');
  const successAlert = document.getElementById('success-alert');
  const successMessage = document.getElementById('success-message');

  // Real-time email validation
  let emailValidationTimeout;
  emailInput.addEventListener('input', function() {
    clearTimeout(emailValidationTimeout);
    const email = this.value.trim();
    
    if (email.length === 0) {
      clearEmailValidation();
      return;
    }

    showEmailLoading();
    emailValidationTimeout = setTimeout(() => validateEmail(email), 500);
  });

  function showEmailLoading() {
    document.getElementById('email-loading').classList.remove('hidden');
    document.getElementById('email-success').classList.add('hidden');
    document.getElementById('email-error').classList.add('hidden');
    document.getElementById('email-error-text').classList.add('hidden');
  }

  function clearEmailValidation() {
    document.getElementById('email-loading').classList.add('hidden');
    document.getElementById('email-success').classList.add('hidden');
    document.getElementById('email-error').classList.add('hidden');
    document.getElementById('email-error-text').classList.add('hidden');
  }

  function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (!emailRegex.test(email)) {
      showEmailError('Please enter a valid email address.');
      return;
    }

    // Simulate API call for email validation
    setTimeout(() => {
      showEmailSuccess();
    }, 300);
  }

  function showEmailSuccess() {
    document.getElementById('email-loading').classList.add('hidden');
    document.getElementById('email-success').classList.remove('hidden');
    document.getElementById('email-error').classList.add('hidden');
    document.getElementById('email-error-text').classList.add('hidden');
  }

  function showEmailError(message) {
    document.getElementById('email-loading').classList.add('hidden');
    document.getElementById('email-success').classList.add('hidden');
    document.getElementById('email-error').classList.remove('hidden');
    document.getElementById('email-error-text').textContent = message;
    document.getElementById('email-error-text').classList.remove('hidden');
  }

  // Form submission
  forgotPasswordForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = emailInput.value.trim();

    if (!email) {
      showError('Please enter your email address.');
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showError('Please enter a valid email address.');
      return;
    }

    try {
      // Show loading state
      resetButtonText.classList.add('hidden');
      resetLoading.classList.remove('hidden');
      resetButton.disabled = true;

      // Submit forgot password request
      const response = await fetch('/auth/forgot-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email }),
      });

      if (response.ok) {
        const result = await response.json();
        showSuccess(result.message || 'Password reset link has been sent to your email.');
        
        // Disable form after successful submission
        emailInput.disabled = true;
        resetButton.style.display = 'none';
        
        // Show additional instruction
        setTimeout(() => {
          showSuccess('Check your email for the password reset link. You can close this page.');
        }, 3000);
      } else {
        const error = await response.json();
        showError(error.message || 'Failed to send reset email. Please try again.');
      }
    } catch (error) {
      console.error('Forgot password error:', error);
      showError('An error occurred. Please try again.');
    } finally {
      // Reset loading state
      resetButtonText.classList.remove('hidden');
      resetLoading.classList.add('hidden');
      resetButton.disabled = false;
    }
  });

  function showSuccess(message) {
    successMessage.textContent = message;
    successAlert.classList.remove('hidden');
  }

  function showError(message) {
    // You can implement a custom error display here
    alert(message);
  }
</script>
{% endblock %}